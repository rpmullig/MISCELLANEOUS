# ---------- USER LAYER ----------

UserLayer: {
  label: "User Layer"
  style.fill: "#f3e5f5"

  Broker: "Broker" {
    shape: class
    style.fill: "#9575cd"
    + Sends submission email with attachments (SOVs, Loss Runs, Apps)
    + Receives quotes, binders, and notifications
  }

  SharedServices: "Shared Services (SSC)" {
    shape: class
    style.fill: "#9575cd"
    + Picks up ImageRight tasks (FIFO Queue)
    + Manually splits files and tags types
    + Extracts submission fields for reservation
    + Creates WWIP submission and gets WWIP ID
    + Reserves in eStart and gets eStart ID \& clearance status
    + Updates WWIP with eStart info
    + Manually overwrites temp ImageRight ID with WWIP ID
  }

  Underwriter: "Underwriter (UW)" {
    shape: class
    style.fill: "#9575cd"
    + Reviews submission materials via WWIP / ImageRight
    + Conducts embedded and external research
    + Decides on GLMS vs WWIP modeling
    + Creates referral, UW notes, selects quote structure
    + Sends indications and final quotes
  }

  COE: "Center of Excellence (COE)" {
    shape: class
    style.fill: "#9575cd"
    + Scrubs and standardizes SOV files
    + Uploads modeling scenarios to GLMS
    + Returns CAT output summaries to UW
  }
}

# ---------- SERVICES ----------

ImageRight: "ImageRight (Email Intake + Doc Mgmt)" {
  shape: class
  style.fill: "#4dd0e1"
  + Sweeps submission inbox (Standard, VIP, Rush)
  + Parses attachments and creates viewable components
  + Creates temporary Drawer and ID
  + Enables SSC to split files, tag SOV, Loss Runs
  + Creates task in queue for SSC
  + Drawer overwritten by WWIP Policy ID
  + URL to Drawer generated from WWIP Policy #
  + Accepts one-way doc push from WWIP via Linker\.exe
}

eStart: "eStart / NGE" {
  shape: class
  style.fill: "#ffb74d"
  + Accepts reservation from SSC
  + Performs block checks (duplicate, sanction)
  + Issues eStart ID and clearance status
  + Sends results to WWIP for status update
  + Allows shell record if account not found
}

WWIP: "WWIP (Submission Management Platform)" {
  shape: class
  style.fill: "#64b5f6"
  + Creates WWIP ID / Policy Number for submission
  + Stores submission metadata and referral records
  + Accepts eStart ID + Clearance Status
  + Tracks status: Reserved, Blocked, Solicited, Quoted
  + Embeds worksheet module for pricing
  + Auto-generates quotes, forms, binders
  + Provides dropdowns for deductibles, endorsements
  + Sends docs to ImageRight via Linker\.exe
  + Links to ImageRight Drawer via WWIP ID
  + Runs geocoding (embedded Google Maps)
  + Calls Validus for Crime, Brush, DTC
  + Retrieves ISO Protection Class via Clarion Door
}

GLMS: "GLMS (Modeling Platform)" {
  shape: class
  style.fill: "#7b9f35"
  + Accepts scenario inputs from UW or COE
  + Prepares file output for Lynx (CAT integration)
  + Re-ingests merged CAT results from Lynx
  + Sends model data to AIGRater (HX) for pricing
  + Uploads scenario outputs to GDMS
}

# ---------- RESEARCH LAYER ----------

ResearchLayer: {
  label: "Research Layer"
  style.fill: "#ede7f6"

  Embedded: {
    label: "Embedded/Internal Services"
    style.fill: "#f0f4c3"

    Validus: "Validus Risk Services" {
      shape: class
      style.fill: "#81c784"
      + Provides ISO, Crime, Brush, DTC scoring after geocode
    }

    WWIPGeocoder: "WWIP Embedded Google Maps" {
      shape: class
      style.fill: "#81c784"
      + Converts address into lat/long for Validus scoring
    }

    ClarionDoor: "Clarion Door (ISO Rating API)" {
      shape: class
      style.fill: "#f48fb1"
      + Returns Protection Class, Fire Symbol for quoting
    }

    PlacelyGeo: "Placely Geoservices" {
      shape: class
      style.fill: "#f48fb1"
      + Validates rooftop match for location accuracy
    }

    Lynx: "Lynx CAT Engine (File-based Orchestrator)" {
      shape: class
      style.fill: "#f48fb1"
      + Accepts CAT model files from GLMS
      + Routes through RMS, AIR, Validus models
      + Merges result and returns to GLMS
    }

    AIGRater: "AIG Rater (HX)" {
      shape: class
      style.fill: "#f48fb1"
      + Accepts modeled data from GLMS
      + Returns final technical premium
    }
  }

  Manual: {
    label: "Manual External Research"
    style.fill: "#ede7f6"

    GoogleMaps: "Google Maps (Manual Review)" {
      shape: class
      style.fill: "#aed581"
      + Visual property check for TIV, environment
    }

    CrimeSpot: "CrimeSpot / SpotCrime" {
      shape: class
      style.fill: "#aed581"
      + Manually lookup neighborhood crime heatmap
    }

    RiskMeter: "RiskMeter" {
      shape: class
      style.fill: "#aed581"
      + Wildfire, Wind risk scoring
    }

    NewsWeb: "Public Sources (Google, Yelp, News)" {
      shape: class
      style.fill: "#aed581"
      + Reputation checks, reviews, lawsuits
    }

    UWGuidelines: "UW Guidelines (OneNote)" {
      shape: class
      style.fill: "#aed581"
      + Judgment rules, escalation triggers, FAC rules
    }
  }
}

# ---------- DATA LAYER ----------

DataLayer: {
  label: "Data Layer"
  style.fill: "#e8f5e9"

  ImageRightDB: "ImageRight Archive" {
    shape: class
    style.fill: "#4fc3f7"
    - Submission docs, SOVs, binders, email snapshots
    - Organized by WWIP Policy ID
  }

  WWIPDB: "WWIP SQL DB" {
    shape: class
    style.fill: "#4fc3f7"
    - Submission state, pre-indication fields
    - Notes, Referrals, Document attachments
    - Stores quote output and UW actions
  }

  GDMS: "GDMS CAT Storage" {
    shape: class
    style.fill: "#4fc3f7"
    - Full modeling outputs
    - Scenarios, limits, perils
  }
}

# ---------- FLOW ----------

UserLayer.Broker -> ImageRight: Sends email submission and attachments
ImageRight -> UserLayer.SharedServices: Parses files and creates task queue
UserLayer.SharedServices -> WWIP: Creates submission record, receives WWIP ID
UserLayer.SharedServices -> eStart: Runs reservation, gets eStart ID \& Clearance
eStart -> WWIP: Updates record with eStart ID and block status
UserLayer.SharedServices -> ImageRight: Overwrites Drawer ID with WWIP Policy Number

WWIP -> UserLayer.SharedServices: Submission ready for UW assignment
WWIP -> UserLayer.Underwriter: Alerts UW

UserLayer.Underwriter -> ImageRight: Reviews structured submission docs
WWIP -> ResearchLayer.Embedded.WWIPGeocoder: Runs address to lat/long
ResearchLayer.Embedded.WWIPGeocoder -> ResearchLayer.Embedded.Validus: Risk scoring triggered
WWIP -> ResearchLayer.Embedded.Validus: Receives ISO, Brush, Crime scores

UserLayer.Underwriter -> GLMS: Sends modeling request
GLMS -> ResearchLayer.Embedded.Lynx: Sends scenario file via cronjob
ResearchLayer.Embedded.Lynx -> GLMS: Returns merged CAT results
GLMS -> ResearchLayer.Embedded.AIGRater: Sends for rating
ResearchLayer.Embedded.AIGRater -> UserLayer.Underwriter: Returns final technical premium

GLMS -> ResearchLayer.Embedded.PlacelyGeo: Validates location data

UserLayer.Underwriter -> ResearchLayer.Manual.GoogleMaps: Views site
UserLayer.Underwriter -> ResearchLayer.Manual.CrimeSpot: Checks crime zone
UserLayer.Underwriter -> ResearchLayer.Manual.RiskMeter: Manually compares hazard data
UserLayer.Underwriter -> ResearchLayer.Manual.NewsWeb: Searches reputation
UserLayer.Underwriter -> ResearchLayer.Manual.UWGuidelines: Checks OneNote playbook

UserLayer.Underwriter -> WWIP: Completes quoting, binds submission
WWIP -> ResearchLayer.Embedded.ClarionDoor: Pulls ISO class info
WWIP -> DataLayer.WWIPDB: Saves final status, quote docs, and forms
WWIP -> DataLayer.ImageRightDB: Pushes documents via Linker\\.exe
GLMS -> DataLayer.GDMS: Archives final scenario files

ImageRight -> DataLayer.ImageRightDB: Stores submission package

# ---------- LEGEND ----------

Legend: "Legend" {
  grid-rows: 2
}

Legend.User: {
  shape: class
  style.fill: "#9575cd"
}
Legend.ImageRight: {
  shape: class
  style.fill: "#4dd0e1"
}
Legend.eStart: {
  shape: class
  style.fill: "#ffb74d"
}
Legend.WWIP: {
  shape: class
  style.fill: "#64b5f6"
}
Legend.GLMS: {
  shape: class
  style.fill: "#7b9f35"
}
Legend.Storage: {
  shape: class
  style.fill: "#4fc3f7"
}
Legend.Tools: {
  shape: class
  style.fill: "#f48fb1"
}
